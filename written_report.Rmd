---
title: "Predicting the Cost of Hotel Booking in the United States"
author: "LAM-duh: Xuliang Deng, Leah Okamura, Megan Richards"
date: "Nov 15th, 2021"
output: 
  pdf_document: 
    toc: true
    toc_depth: 1
    number_sections: true

bibliography: references.bib
link-citations: true
---


```{r ggplot2-options, include = FALSE}
# set consistent theme
#theme_set(ggplot2::theme_minimal())
color_palette <- list(gray = "#999999", 
                      green = "#009E73", 
                      yellow = "#F0E442", 
                      darkblue = "#0072B2", 
                      purple = "#800080", 
                      orange = "#ff8c00",
                      cyan = "#008B8B"
                      )
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages,include=FALSE}
library(tidyverse)
library(patchwork)
library(knitr)
library(tidymodels)
library(ggfortify)
library(ggplot2)
#install.packages("Rpdb")
``` 

```{r load-data,include=FALSE}
hotels <- read_csv("data/hotels_reduced.csv")
```

### Introduction 

Hotels are a critical component of the travel sector in the U.S., with an estimated 5.3 million guest rooms, and supporting 1 in 25 American jobs on average prior to 2020 based on [this source](https://www.ahla.com/sites/default/files/2021_state_of_the_industry_0.pdf). [A 2018 report](https://www.trekksoft.com/en/blog/65-travel-tourism-statistics-for-2019) showed that 
approximately two thirds of Americans book their hotels directly through hotel websites, and [a 2019 analysis](https://globalnews.booking.com/bookingcom-reveals-key-findings-from-its-2019-sustainable-travel-report/) showed large
discrepancies in consumer travel cost based on how consumers chose to prioritize booking lodging compared to activities. 
We are interested in analyzing U.S. hotel bookings, with the goal of providing insight to consumers on the factors that affect their hotel cost.Our general research question is: How do the characteristics of a hotel booking affect the daily cost of a hotel stay in the United States? We believe there will be several significant points of relevance for understanding these relationships: understanding predictors of room cost could be used to help travelers to plan financially for future travel, or to potentially reduce cost. In this report, we are looking to use a variety of chosen models to understand the contributing factors to the average daily rate of a hotel room, as well as identify the strongest predictors.

### Data 

The source of the dataset is [Tiny Tuesday](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-02-11/readme.md).
This data set was originally collected from an open hotel booking demand dataset [@ANTONIO201941]. The data collected from hotels all around the world ranges from bookings in 2015 to 2017. It is sourced from [this study](https://www.sciencedirect.com/science/article/pii/S2352340918315191#f0010). Due to the dataset being over 100,000 observations, we have limited the observations to be only hotels from the US. The general characteristics being measured in the data are the different aspects of booking and staying at a hotel. For example, out of the 32 variables, some of the ones we find great interest in are hotel type, reserved room type, assigned room type, company, meal, number of adults/children/babies, the average daily rate or daily cost, and the reservation status. Therefore, each observation is one booking/stay at a specific hotel in America and all of its characteristics. Therefore, there can be multiple observations from the same hotel and even on the same time range. The full dataset dictionary can be found in the repository ReadMe. 

### Resesarch Question 

To better understand the contributing factors to the daily rate of hotel rooms in the U.S., we will build models to:

1) Evaluate the efficacy of this model to predict daily hotel room rates
2) Evaluate the statistical significance of each predictor, identifying the strongest contributing factors. We include the following variables in our analysis: hotel type, company, meal, number of adults/children/babies, the average daily rate or daily cost, and the reservation status.

### Exploratory data analysis

#Appendix


```{r response-plot}
ggplot(data = hotels, aes(x = adr)) +
  geom_histogram(fill = 2) + 
  labs(x = "Price in US Dollars",
       y = "Frequency", 
       title = "Distribution of Average Daily Rate (Cost) of Hotel Bookings",
       subtitle = "Collected from Hotels in the U.S. from 2015-2017")

```

```{r summary stats}
hotels %>%
    summarise(mean = mean(adr), 
              median = median(adr), 
              sd = sd(adr),
              min = min(adr),
              max = max(adr),
              iqr = IQR(adr))%>%
kable(digits = 3)
```

The response variable, adr, has a somewhat skewed right, bimodal distribution. The average or mean average daily rate is \$122.992 and the median is $115. Because the distribution is skewed, the median is most likely the best indicator for the center. The standard deviation is \$51.617 and the data ranges from \$0 to \$328.33 with an interquartile range of \$61.99.

#Appendix
```{r}
adults <- sum(hotels$adults)
children <- sum(hotels$children)
babies <- sum(hotels$babies)

tb <- table(adults, children, babies)
kable(tb)
```

This table provides insight on the type of people who were booking hotels in the U.S. during this time period. A large majority of customers were only adults with a total of 3,950 hotel bookings. The next largest customer group were people or adults with their children at a total of 362 bookings. Lastly, those who booked a stay with a baby was considerably less, with only 6 bookings.

#Appendix
```{r}
ggplot(data = hotels, aes(x = meal)) +
geom_bar(fill = 2) +
labs(title = "Distribution of Meal Plan According to Booking Details",
      y = "Frequency",
      x = "Type of Meal Plan") 
```
#Appendix

```{r}
hotels %>%
  group_by(meal) %>%
  summarise(n = n(), mean = mean(adr), sd = sd(adr)) %>%
  kable(digits = 3)
```

We can see that majority of customer bookings chose the Bed and Breakfast plan (BB), rather than Half Board plan or Full Board (HB and SC). While this does reflect the choice of those booking the hotel, this visualization and dataset can also be influenced by what type of meal plan each hotel is offering. 

#Appendix
```{r}
ggplot(data = hotels, aes(x = reservation_status)) +
geom_bar(fill = 2) +
labs(title = "Distribution of Reservation Status",
  x = "Type of Status",
  y = "Frequency") 
```
A vast majority of the reservation statuses in this dataset resulted in a check-out, meaning that the customer arrived and stayed for the duration of the stay. It also important to note that a substantial proportion of hotel bookings were canceled, and if possible we would like to investigate what relationship might exist here.

```{r}
hotels %>%
  group_by(hotel) %>%
  summarise(n = n(), mean = mean(adr), sd = sd(adr)) %>%
  kable(digits = 3)
```
We can see that resort hotel is on average more expensive, and that most customers booked at city hotels. We are interested in whether the classification of City Hotel and Resort Hotel will proportionately have similar relationships with the other variables.

```{r}
ggplot(data = hotels, aes(x = lead_time, y = adr)) +
geom_point(colour = "red") +
labs(title = "Relationship between how early people book hotel and price in the US dollars",
  x = "Subtraction of entering date from arrival date",
  y = "Price in the US Dollars") 
```
We can see that the more last minute visitors book a hotel, the more likely it is that the price in the US dollars varies. Besides, we can also see that the highest price in a hotel decreases as the difference between entering data and arrival date increases. This could suggest that the earlier you book a hotel, the price is more likely to be cheap. 

```{r}
ggplot(data = hotels, aes(x = adr, y = arrival_date_day_of_month)) +
geom_point(colour = "red") +
labs(title = "Relationship between day in the month when hotels are booked and price in the US dollars",
  x = "Day in the month",
  y = "Price in US Dollars") 
```
We cannot see any significant relationship between day in the month and the hotel price from this figure. However, we can see that summer is the busiest season for hotels and the price varies evenly. At the beginning of the year and the end of the year, hotels are not really booked as often. 

```{r}
ggplot(data = hotels, aes(x = arrival_date_week_number, y = adr)) +
geom_point(colour = "red") +
labs(title = "Relationship between week in the year when hotels are booked and price in the US dollars",
  x = "Week in the year",
  y = "Price in US Dollars") 
```
From this figure, we can also see that at the beginning and end of the year hotels are not as busy as during the summer. Besides, we can also observe that the price of hotel tends to become higher during summer time compared to the rest of the year. 

We are particularly interested in using the hotel type (Resort versus City Hotel) as a predictor of average daily rate. As an initial analysis, we perform a t-test on the the average daily rates of bookings for resort versus city hotels. This t-test assesses if there is a significant difference between the two distributions, which would indicate that hotel type is likely to be a useful predictor of average daily rate. In this analysis, we find that our t-test produces a p-value of 0.002305%. Because this p-value is very low, we conclude that there is a statistically significant relationship between the average daily hotel rates of resort hotels and city hotels in our dataset, which provides evidence that hotel type is a useful predictor of average daily hotel rates. 

```{r}
ggplot(data = hotels, aes(x = hotel)) +
geom_bar(fill = 2) +
labs(title = "Distribution of Hotel Type",
  x = "Type of Hotel",
  y = "Frequency")
```

```{r resort-t-test}
resort_adr <- hotels[hotels$hotel == "Resort Hotel",]$adr
city_adr <- hotels[hotels$hotel == "City Hotel",]$adr

hotel_type_p_value <- t.test(resort_adr, city_adr)$p.value
print(hotel_type_p_value)
```

```{r adult-t-test}
hotels <-hotels%>%
  mutate(children_present = case_when
         (hotels$adults > 0 & hotels$children == 0 & hotels$babies == 0 ~ 0,
          hotels$children > 0 | hotels$babies > 0 ~ 1), 
         children_present = factor(children_present, 
                          levels = c(0,1)))

adult_adr <- hotels[hotels$children_present == 0,]$adr
kids_adr <- hotels[hotels$children_present == 1,]$adr

resident_type_p_value <- t.test(adult_adr, kids_adr)$p.value
print(resident_type_p_value)
```
We are also particularly interested in using the presence of kids (children or babies) as a predictor of average daily rate. As an initial analysis, we perform a t-test on the the average daily rates of bookings for groups with only adults, versus groups with children or babies. This t-test assesses if there is a significant difference between the two distributions, which would indicate that the presence of kids is likely to be a useful predictor of average daily rate. In this analysis, we find that our t-test produces a p-value of 1.13e-33%. Because this p-value is very low, we conclude that there is a statistically significant relationship between the average daily hotel rates of groups with children or babies and groups with only adults in our dataset, which provides evidence that the presence of kids (children or babies) is a useful predictor of average daily hotel rates. 

## Methodology

### Modeling Choices (Description) 
- Data transformations (if applied)
- Model Type Justification 
- Model selection criteria 
- Handling Interaction Terms 
- Any other technical choices 

It is important to note that there are a few variables in the dataset that do not provide insight to our research question and as a result we will remove from the dataset. First is the category `hotels$country`, due to the fact that every hotel in this subset of the data is located in the U.S., this is a redundant variable. Next, the two variables `hotels$reserved_room_type` and `hotels$assigned_room_type` are both categorical variables that have letters assigned to each room type. However, due to the confidentiality of the customers, the classification of these letters have not been identified by those who collected the data. Therefore, we will be removing these variables from the dataset.


```{r}

hotels <- na.omit(hotels)
hotels <- subset(hotels, select = -country)
hotels <- subset(hotels, select = -reserved_room_type)
hotels <- subset(hotels, select = -assigned_room_type)
hotels <- subset(hotels, select = -agent)
hotels <- subset(hotels, select = -company)
hotels <- subset(hotels, select = -reservation_status_date)
hotels <- subset(hotels, select = -previous_cancellations)
hotels <- subset(hotels, select = -reservation_status)



if (hotels$arrival_date_week_number >=36 & hotels$arrival_date_week_number<=39)
{hotels$arrival_date_month = "September"}
if (hotels$arrival_date_week_number >=1 & hotels$arrival_date_week_number<=4)
{hotels$arrival_date_month = "January"}

  
hotels <- hotels%>%
  mutate(arrival_date_month = factor(arrival_date_month, 
  levels = c("January", "February", "March", "April",
           "May", "June", "July", "August",
           "September", "October", "November",
           "December")), 
          arrival_date_year = factor(arrival_date_year, 
                                     levels = c(2015, 2016, 2017)),
          meal = case_when(meal == "SC" | meal == "Undefined" ~ "None",
                           meal == "BB" ~ "BB",
                           meal == "HB" ~ "HB"),
          meal = factor(meal, levels = c("None", "BB", "HB")))
```

As of now, we know we are going to use hotel (Resort Hotel or City Hotel), company, customer_type, stays_in_weekend_nights, stays_in_week_nights, and  meal(type of meal) as predictor variables. We are interested in how the food is served at a hotel and what type of hotel can indicate how much a night in a hotel could cost. As we explore more of the relationships in our dataset, we may add other possible predictor variables as we see fit.

We plan to use multiple linear regression with a variety of combinations of interested predictor variables and their interaction. Based on whether conditions or fit or not or based on the visualization, we believe we may be utilizing logarithmic regression as well. We would also be interested in seeing how stays in the weekend or the weekday may affect the average daily rate for a hotel, and if they differ between the two hotel types, City and Resort hotels.


```{r}
set.seed(12121)
hotel_split <- initial_split(hotels, prop = 0.8) #80% in the training set
hotel_train <- training(hotel_split) 
hotel_test <- testing(hotel_split)
hotel_test <- hotel_test[!(hotel_test$meal=='Undefined'),]
rownames(hotel_train) <- NULL
rownames(hotel_test) <- NULL
nrow(hotels)
nrow(hotel_test)
```




```{r}
full_model <- lm(adr ~ ., data = hotels)
tidy(full_model) %>%
  kable(digits = 3)
```

```{r results = "hide"}
selected_model <- stats::step(full_model, scope=formula(full_model), direction="backward", k = log(nrow(hotels)))
```

```{r}
tidy(selected_model) %>%
  kable()
```


### Modeling 


### Conditions Check For Linear Model  

```{r }
# Residual + QQ Plots
autoplot(selected_model, which = c(1,2),  colour = "red")
```
To check that a linear model is applicable to this dataset, we check the following conditions: Linearity, Constant Variance, Normality, and Independence. 

To check for Linearity, we look at the residuals vs fitted plot. We see that the residuals are randomly scattered, which indicates that the linearity condition is met. 

To check for constant variance, we look at the spread of the residuals in the residuals vs fitted plot. We see that the spread of the residuals is approximately equal as the fitted value increases, indicating that the constant variance condition is satisfied.

To check for normality, we look at the QQ-plot for a linear relationship. In the plot, we see a mostly linear relationship, and additionally recognize that our model is robust to deviations because our number of samples is much larger than 30. Therefore, we conclude that the normality condition is met. 

To check for independence, we look at the study design, and find that there is 
no reason to believe that our samples are not independent from the survey, such that 
individual hotel bookings can be assumed to be independent. 

From this analysis, we conclude that the conditions are met for performing  linear regression. 

## Results


$$\hat{Average Daily Rate} = 79.723	 + 79.723	(adults) + 35.169(children)$$
$$ -22.637(babies) + 2.353(hotel Resort Hotel) + 33.779 (mealHB) - 17.205(mealSc)$$
$$+106.033(mealUndefined)-12.809(reservationstatusCheck-Out) - 2.662(reservationstatusNo-Show)$$

To determine the predictive ability of our model, we use the Root Mean Squared Error 
on both our training and test datasets below. We find a very similar error between 
our training and test sets, and find that on average, our predictions differ 
from the actual value by around $43. 

```{r}
#train_pred <- tibble(predicted = predict(model, hotel_train)) %>%
#                          bind_cols(hotel_train)
#train_pred %>%
# rmse(truth = adr, estimate = predicted)
#test_pred <- tibble(predicted = predict(model, hotel_test)) %>%
#                          bind_cols(hotel_test)
#test_pred %>%
#  rmse(truth = adr, estimate = predicted)
```

### Diagnostics 

```{r}
autoplot(selected_model, which = c(3, 4, 5), colour = "red")

#Leverage 
lev_threshold <- 2 * 2 / nrow(hotels) 
hotel_aug <- augment(selected_model) 

hotel_aug %>%
filter(.hat > lev_threshold) %>% nrow()

# High Magnitude Residual 
hotel_aug %>%
filter(.std.resid < -3 | .std.resid > 3) %>% nrow()

# Influential Point 
hotel_aug %>%
filter(.cooksd > 1.0) %>% nrow()
 
```
We use leverage and Cook's Distance to identify influential observations in our dataset, and use standardized residuals to identify outliers. 

Leverage is a measure of the distance between an observation's values of the predictor variables and the average values of the predictor variables for the entire data set. We define a high leverage point as having a leverage greater than $ 2(p+1) /n  $, where p is the number of predictors and n is the number of observations. We find X observations to be high leverage, and consider them to be
potential influential points. 

Cook's distance is a composite measure of an observation's leverage and standardized residual, and is used to identify influential points. An observation is considered an influential point if it’s Cook’s distance is greater than 1.0. We find X observations with a Cook's distance greater than 1.0, and conclude that they are influential points. 

Standardized residuals can be used to identify outliers, as observations that have standardized residuals of large magnitude don't fit the pattern determined by the regression model. We identify outliers as observations with standardized residuals with a magnitude greater than or equal to 3. We find X observations to be outliers.

```{r plot_outliers}
hotel_aug <- hotel_aug %>%
mutate(outlier = if_else(.std.resid < -3 | .std.resid > 3, "Yes", "No"))

ggplot(hotel_aug, aes(x = adults, y = adr)) + geom_point(aes(color = outlier)) +
geom_smooth(method = "lm", se = FALSE) + labs(title = "Plotting of Outliers",
      y = "Average Daily Rate",
      x = "Adults") 
```

### Model Assumptions, Limitations
Our model assumes that hotel bookings are independent from each other, which could 
potentially be broken in limited circumstances, such as competing hotel holiday 
promotions.  

It's important to recognize that our model has several limitations. First, we recognize
that the travel industry (including hotel booking) is incredibly vulnerable to 
tragic circumstances or disasters, which are not accounted for in our model. For example, 
we recognize that our model is not likely to characterize hotel bookings during COVID, given that our 
data is limited to the years 2015 to 2017. 
Additionally, we anticipate that the hotel room type (such as suite versus 
individual room) would be an important predictor of hotel room price, but is not 
included in our model. Our dataset included a variable for the room type, but it 
was mapped to a anonymous letter system (A,B,C..) to protect industry knowledge. 
We excluded this variable because it would be impossible to use in the real 
world without knowing what mapping was applied. 
In our exploratory analysis, we found that there were far more hotel bookings in 
cities than in resorts. Given this skew, our model may better characterize city 
bookings than resort bookings. 


### Interpretations and Conclusions 

$$\hat{Average Daily Rate} = 79.723	 + 79.723	(adults) + 35.169(children)$$
$$ -22.637(babies) + 2.353(hotel Resort Hotel) + 33.779 (mealHB) - 17.205(mealSc)$$
$$+106.033(mealUndefined)-12.809(reservationstatusCheck-Out) - 2.662(reservationstatusNo-Show)$$
It does not make sense to interpret the intercept because there will be no case where people are not included in one of the adults, children, or babies categories. The slope for adults means that for each additional number of adults, the average daily rate of hotel is expected to increase by 79.723 dollars. The slope for children means that for each additional number of children, the average daily rate of hotel is expected to increase by 35.169 dollars. The slope for babies means that for each additional number of babies, the average daily rate of hotel is expected to decrease by 22.637 dollars. The slope for hotelResortHotel means that if the hotel is resort hotel instead of city hotel, the average daily rate of hotel is expected to increase by 2.353 dollars. The slope for mealHB, mealSc, mealUndefined means that if selected meal is half board (breakfast and dinner), the average daily rate of hotel is expected to increase by 33.779 dollars, and if selected meal is undefined or SC, the average daily rate of hotel is expected to increase 
If the reservation last status is 


# References


<div id="refs">

</div>


# Appendix

## Exploratory Data Analysis \label{appendix:eda}

```{r}
```
